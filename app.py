import os
import re
from flask import Flask, request
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from db import (
    save_expense, get_monthly_transactions, get_daily_expense,
    delete_expense_by_id, update_expense_amount_by_id, update_category_by_id,
    set_spending_alert, check_spending_alert, add_new_category, clear_all_expenses,
    get_last_expense_id
)

import os

LINE_ACCESS_TOKEN = os.getenv("LINE_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

app = Flask(__name__)

import openai
openai.api_key = os.getenv("OPENAI_API_KEY")

line_bot_api = LineBotApi(LINE_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)


# âœ… **è®“ AI ä¾†åˆ¤æ–·ç”¨æˆ¶çš„æ„åœ–**
import json

def interpret_user_intent(user_input):
    """ ğŸŒŸ ä½¿ç”¨ GPT-4 è§£æç”¨æˆ¶è¼¸å…¥çš„æ„åœ– """
    prompt = f"""
    ä½ æ˜¯ä¸€å€‹æ™ºèƒ½è¨˜å¸³æ©Ÿå™¨äººï¼Œè«‹è§£æç”¨æˆ¶è¼¸å…¥çš„æŒ‡ä»¤ä¸¦è¿”å› JSON æ ¼å¼ï¼š
    
    - `intent`: ç”¨æˆ¶çš„æ„åœ–ï¼ˆ"è¨˜å¸³"ã€"æŸ¥è©¢æœ¬æœˆ"ã€"æŸ¥è©¢ç‰¹å®šæ—¥æœŸ"ã€"åˆªé™¤"ã€"ä¿®æ”¹é‡‘é¡"ã€"ä¿®æ”¹åˆ†é¡"ã€"æ¸…é™¤æ‰€æœ‰è¨˜éŒ„"ã€"è¨­å®šæé†’"ã€"æ–°å¢åˆ†é¡"ï¼‰
    - `params`: ç›¸é—œåƒæ•¸ï¼Œä¾‹å¦‚ `{user_input}` å¯èƒ½è§£ææˆï¼š
        - `"æ‹‰éºµ 150"` â†’ `{{"intent": "è¨˜å¸³", "params": {{"item": "æ‹‰éºµ", "amount": 150}}}}`
        - `"é€™å€‹æœˆèŠ±äº†å¤šå°‘"` â†’ `{{"intent": "æŸ¥è©¢æœ¬æœˆ", "params": {{}}}}`
        - `"åˆªé™¤å‰›å‰›é‚£ç­†"` â†’ `{{"intent": "åˆªé™¤", "params": {{}}}}`

    è‹¥ç„¡æ³•è§£æï¼Œè«‹å›å‚³ï¼š
    `{{"intent": "æœªçŸ¥", "params": {{}}}}`
    
    ç¾åœ¨è«‹è§£æé€™å¥è©±ï¼š
    "{user_input}"
    """

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-turbo",
            messages=[{"role": "system", "content": "ä½ æ˜¯ä¸€å€‹æ™ºèƒ½è¨˜å¸³æ©Ÿå™¨äºº"},
                      {"role": "user", "content": prompt}]
        )

        ai_output = response.choices[0].message.content.strip()
        print(f"ğŸŸ¢ AI å›æ‡‰: {ai_output}")  # âœ… Debug çœ‹ AI å›æ‡‰æ˜¯å¦æ­£å¸¸

        # ç¢ºä¿ AI å›æ‡‰ç¬¦åˆ JSON æ ¼å¼
        parsed_response = json.loads(ai_output)

        return parsed_response.get("intent", "æœªçŸ¥"), parsed_response.get("params", {})

    except Exception as e:
        print(f"âŒ AI è§£æå¤±æ•—: {e}")
        return "æœªçŸ¥", {}


# âœ… **è™•ç† Line Webhook**
@app.route("/callback", methods=["POST"])
def callback():
    """ ğŸ“¨ æ¥æ”¶ Line è¨Šæ¯ """
    signature = request.headers["X-Line-Signature"]
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        return "Invalid signature", 400

    return "OK"

# âœ… **è™•ç†ä½¿ç”¨è€…è¼¸å…¥**
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    """ ğŸ”¥ æ¥æ”¶ç”¨æˆ¶è¨Šæ¯ï¼Œä¸¦æ ¹æ“š AI åˆ¤æ–·çš„æ„åœ–åŸ·è¡Œå°æ‡‰å‹•ä½œ """
    user_id = event.source.user_id
    text = event.message.text.strip()

    # âœ… è®“ AI è§£æç”¨æˆ¶è¼¸å…¥
    intent, params = interpret_user_intent(text)

    if intent == "è¨˜å¸³":
        item = params.get("item")
        amount = params.get("amount")

        if item and amount:
            category = save_expense(user_id, item, amount)
            reply = f"âœ… å·²è¨˜éŒ„ï¼š{item} {amount} å…ƒï¼ˆåˆ†é¡ï¼š{category}ï¼‰"
        else:
            reply = "âŒ è¨˜å¸³æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ã€Œå“é … é‡‘é¡ã€ï¼Œä¾‹å¦‚ï¼šæ‹‰éºµ 150"

    elif intent == "æŸ¥è©¢æœ¬æœˆ":
        reply = get_monthly_transactions(user_id)

    elif intent == "æŸ¥è©¢ç‰¹å®šæ—¥æœŸ":
        date = params.get("date")
        reply = get_daily_expense(user_id, date) if date else "âŒ è«‹è¼¸å…¥æ­£ç¢ºæ—¥æœŸ"

    elif intent == "åˆªé™¤":
        expense_id = params.get("expense_id") or get_last_expense_id(user_id)
        if expense_id:
            reply = delete_expense_by_id(user_id, expense_id)
        else:
            reply = "âŒ æ‰¾ä¸åˆ°å¯åˆªé™¤çš„è¨˜éŒ„"

    elif intent == "ä¿®æ”¹åˆ†é¡":
        expense_id = params.get("expense_id") or get_last_expense_id(user_id)
        new_category = params.get("new_category")
        if expense_id and new_category:
            reply = update_category_by_id(user_id, expense_id, new_category)
        else:
            reply = "âŒ ä¿®æ”¹åˆ†é¡æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ã€Œä¿®æ”¹åˆ†é¡ è¨˜éŒ„ID æ–°åˆ†é¡ã€"

    elif intent == "ä¿®æ”¹é‡‘é¡":
        expense_id = params.get("expense_id") or get_last_expense_id(user_id)
        new_amount = params.get("new_amount")
        if expense_id and new_amount:
            reply = update_expense_amount_by_id(user_id, expense_id, new_amount)
        else:
            reply = "âŒ ä¿®æ”¹é‡‘é¡æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ã€Œä¿®æ”¹é‡‘é¡ è¨˜éŒ„ID æ–°é‡‘é¡ã€"

    elif intent == "æ¸…é™¤æ‰€æœ‰è¨˜éŒ„":
        reply = clear_all_expenses(user_id)

    elif intent == "è¨­å®šæé†’":
        category = params.get("category")
        limit = params.get("limit")
        if category and limit:
            reply = set_spending_alert(user_id, category, limit)
        else:
            reply = "âŒ è¨­å®šæé†’æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ã€Œè¨­å®šæé†’ é¡åˆ¥ ä¸Šé™é‡‘é¡ã€"

    elif intent == "æ–°å¢åˆ†é¡":
        category_name = params.get("category_name")
        if category_name:
            reply = add_new_category(user_id, category_name)
        else:
            reply = "âŒ è«‹è¼¸å…¥è¦æ–°å¢çš„åˆ†é¡åç¨±"

    else:
        reply = "âŒ ç„¡æ³•ç†è§£ä½ çš„æŒ‡ä»¤ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆæŒ‡ä»¤"

    # âœ… ç™¼é€å›æ‡‰
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))


if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)



